<?php
/**
 * Created by PhpStorm.
 * User: zero
 * Date: 5/21/17
 * Time: 7:19 PM
 */

namespace GoogleCapcay;

class TransferResponseToGoogle
{
	/*
	|------------------------------------------------------------------------------
	| Curl Resource
	|------------------------------------------------------------------------------
	*/
	private $curl;

	/*
	|------------------------------------------------------------------------------
	| Post Parameter to Google Captcha
	|------------------------------------------------------------------------------
	*/
	private $postArray = null;

	/*
	|------------------------------------------------------------------------------
	| Constructor
	|------------------------------------------------------------------------------
	*/
	public function __construct
	(
		$url = "https://www.google.com/recaptcha/api/siteverify", //Default URL google Captcha
		array $options = [] //Default Option for Curl
	)
	{
		/*
		|------------------------------------------------------------------------------
		| Curl Initial
		|------------------------------------------------------------------------------
		*/
		$this->curl = curl_init($url);

		/*
		|------------------------------------------------------------------------------
		| Iterated Options if Available
		|------------------------------------------------------------------------------
		*/
		foreach ($options as $key => $value)
		{
			curl_setopt(
				$this->curl,
				$key,
				$value
			);
		}

		/*
		|------------------------------------------------------------------------------
		| Required Option curl CURLOPT_RETURNTRANSFER
		|------------------------------------------------------------------------------
		*/
		curl_setopt(
			$this->curl,
			CURLOPT_RETURNTRANSFER,
			true
		);
	}

	/*
	|------------------------------------------------------------------------------
	| Initial Post Array
	|------------------------------------------------------------------------------
	*/
	public function FieldPost(array $param)
	{
		$this->postArray = $param;

		return $this;
	}

	/*
	|------------------------------------------------------------------------------
	| Do Transfer
	|------------------------------------------------------------------------------
	*/
	public function Transfer()
	{
		/*
		|------------------------------------------------------------------------------
		| Throw Exception if Post Field Empty
		|------------------------------------------------------------------------------
		*/
		if($this->postArray == null)
		{
			throw new CapcayException("CURLOPT_POSTFIELDS Can't be Empty");
		}

		/*
		|------------------------------------------------------------------------------
		| Curl POST
		|------------------------------------------------------------------------------
		*/
		curl_setopt(
			$this->curl,
			CURLOPT_POSTFIELDS,
			$this->postArray
		);

		/*
		|------------------------------------------------------------------------------
		| Curl Execute
		|------------------------------------------------------------------------------
		*/
		$response = curl_exec($this->curl);
		$error    = curl_error($this->curl);
		$errno    = curl_errno($this->curl);

		/*
		|------------------------------------------------------------------------------
		| Close if Curl is CURL RESOURCE
		|------------------------------------------------------------------------------
		*/
		if(is_resource($this->curl))
		{
			curl_close($this->curl);
		}

		/*
		|------------------------------------------------------------------------------
		| Throw if Any Error
		|------------------------------------------------------------------------------
		*/
		if($errno != 0)
		{
			throw new GoogleCapcayRuntimeException($error, $errno);
		}

		print_r($response);

		/*
		|------------------------------------------------------------------------------
		| Return Response from Google
		|------------------------------------------------------------------------------
		| TODO: Convert to Object if Return JSON
		*/
		return $response;
	}
}